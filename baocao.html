<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>B√°o C√°o Chi Ti·∫øt - WebGIS An Giang</title>

    <!-- Th∆∞ vi·ªán Xu·∫•t Excel (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
      body {
        background-color: #525659; /* M√†u n·ªÅn x√°m gi·ªëng tr√¨nh ƒë·ªçc PDF */
        margin: 0;
        padding: 30px;
        font-family: "Times New Roman", Times, serif;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* Thanh c√¥ng c·ª• ƒëi·ªÅu khi·ªÉn */
      .toolbar {
        width: 100%;
        max-width: 1000px;
        background: #323639;
        padding: 10px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        position: sticky;
        top: 10px;
        z-index: 100;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        color: white;
        transition: 0.2s;
        font-family: sans-serif;
        font-size: 13px;
      }
      .btn-excel {
        background-color: #1e88e5;
      }
      .btn-excel:hover {
        background-color: #1565c0;
      }
      .btn-print {
        background-color: #d32f2f;
      }
      .btn-print:hover {
        background-color: #b71c1c;
      }

      /* T·ªù gi·∫•y A4 */
      .a4-page {
        background: white;
        width: 100%;
        max-width: 1000px;
        min-height: 1414px;
        padding: 60px 80px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        color: #000;
        box-sizing: border-box;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        border-bottom: 2px solid #000;
        padding-bottom: 20px;
      }
      .title {
        font-size: 26px;
        font-weight: bold;
        margin: 0;
        text-transform: uppercase;
        color: #2e7d32;
      }
      .subtitle {
        font-size: 14px;
        margin-top: 5px;
        color: #555;
      }

      .meta-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        font-style: italic;
        font-size: 15px;
      }

      /* B·∫£ng d·ªØ li·ªáu t·ªëi ∆∞u cho h√†ng ng√†n d√≤ng */
      .table-container {
        width: 100%;
        overflow-x: auto;
        margin-top: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }
      th,
      td {
        border: 1px solid #000;
        padding: 8px;
        text-align: left;
        vertical-align: top;
        word-break: break-word;
      }
      th {
        background-color: #f2f2f2;
        text-align: center;
        font-weight: bold;
      }
      tr:nth-child(even) {
        background-color: #fafafa;
      }

      .footer {
        margin-top: 60px;
        text-align: right;
      }
      .signature-box {
        margin-top: 10px;
        padding-right: 40px;
        font-weight: bold;
      }

      /* Hi·ªáu ·ª©ng ƒëang t·∫£i */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #2e7d32;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Thi·∫øt l·∫≠p khi b·∫•m In (Ctrl + P) */
      @media print {
        body {
          background: white;
          padding: 0;
        }
        .toolbar {
          display: none !important;
        }
        .a4-page {
          box-shadow: none;
          padding: 0;
          max-width: 100%;
          margin: 0;
        }
        table {
          font-size: 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- M√†n h√¨nh ch·ªù khi load d·ªØ li·ªáu kh·ªïng l·ªì -->
    <div id="loading-overlay">
      <div class="spinner"></div>
      <p style="margin-top: 15px; font-family: sans-serif; font-weight: bold">
        ƒêang x·ª≠ l√Ω v√† tr√≠ch xu·∫•t d·ªØ li·ªáu...
      </p>
    </div>

    <div class="toolbar">
      <button class="btn btn-excel" id="btnExportExcel">
        üì• T·∫£i file Excel (.xlsx)
      </button>
      <button class="btn btn-print" id="btnExportPDF">
        üñ®Ô∏è In B√°o C√°o / Xu·∫•t PDF
      </button>
    </div>

    <div class="a4-page">
      <div class="header">
        <h1 class="title">B√ÅO C√ÅO TH·ªêNG K√ä CHI TI·∫æT</h1>
        <p class="subtitle">
          H·ªá th·ªëng Th√¥ng tin ƒê·ªãa l√Ω (WebGIS) Qu·∫£n l√Ω T√†i nguy√™n t·ªânh An Giang
        </p>
      </div>

      <div class="meta-info">
        <span>Ng∆∞·ªùi l·∫≠p: Qu·∫£n tr·ªã vi√™n h·ªá th·ªëng</span>
        <span id="txtNgayLap">Ng√†y l·∫≠p: ...</span>
      </div>

      <p style="font-size: 15px">
        K·∫øt qu·∫£ tr√≠ch xu·∫•t l·ªõp d·ªØ li·ªáu:
        <b id="txtTenLop" style="color: #d32f2f; text-transform: uppercase"
          >...</b
        >
        <br />T·ªïng s·ªë ƒë·ªëi t∆∞·ª£ng ghi nh·∫≠n:
        <b id="txtTongSo" style="color: #1e88e5">0</b>
      </p>

      <div class="table-container">
        <table id="tableReport">
          <thead id="theadReport"></thead>
          <tbody id="tbodyReport"></tbody>
        </table>
      </div>

      <div class="footer">
        <div>An Giang, ng√†y ...... th√°ng ...... nƒÉm 2026</div>
        <div class="signature-box">X√ÅC NH·∫¨N C·ª¶A C∆† QUAN CHUY√äN M√îN</div>
        <div style="margin-top: 80px; padding-right: 65px">
          (K√Ω t√™n v√† ƒë√≥ng d·∫•u)
        </div>
      </div>
    </div>

    <script>
      // T√≠ch h·ª£p t·ª´ ƒëi·ªÉn v√†o trang b√°o c√°o ƒë·ªÉ d·ªãch c·ªôt chu·∫©n x√°c
      const TU_DIEN_COT = {
        ten: "T√™n t√†i nguy√™n",
        ten_don_vi: "T√™n m·ªè / ƒê∆°n v·ªã",
        ten_loai: "T√™n lo√†i sinh v·∫≠t",
        nhom: "Nh√≥m",
        loai: "Lo·∫°i",
        loai_rung: "Lo·∫°i r·ª´ng",
        loai_khoang_san: "Lo·∫°i kho√°ng s·∫£n",
        loai_dat_su_dung: "Lo·∫°i ƒë·∫•t",
        nhom_su_dung: "Nh√≥m s·ª≠ d·ª•ng",
        tinh_trang: "T√¨nh tr·∫°ng",
        dien_tich: "Di·ªán t√≠ch",
        dien_tich_ha: "Di·ªán t√≠ch (Hecta)",
        dien_tich_m2: "Di·ªán t√≠ch (m2)",
        tru_luong: "Tr·ªØ l∆∞·ª£ng",
        dia_chi: "ƒê·ªãa ch·ªâ",
        doi_tuong_bao_ve: "ƒê·ªëi t∆∞·ª£ng b·∫£o v·ªá",
        cap: "C·∫•p",
        phan_loai: "Ph√¢n lo·∫°i",
        vi_tri_phan_bo: "V·ªã tr√≠ ph√¢n b·ªë",
        muc_do_nguy_cap: "M·ª©c ƒë·ªô nguy c·∫•p",
        nguon_du_lieu: "Ngu·ªìn d·ªØ li·ªáu",
        nguon: "Ngu·ªìn tham kh·∫£o",
      };

      let reportData = null;

      window.onload = function () {
        // L·∫•y d·ªØ li·ªáu t·ª´ sessionStorage do trang B·∫£n ƒë·ªì g·ª≠i sang
        const raw = sessionStorage.getItem("webgis_report_data");
        if (!raw) {
          alert(
            "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu! Vui l√≤ng th·ª±c hi·ªán th·ªëng k√™ ·ªü trang b·∫£n ƒë·ªì tr∆∞·ªõc.",
          );
          window.close();
          return;
        }

        // D√πng setTimeout ƒë·ªÉ giao di·ªán Loading hi·ªán l√™n tr∆∞·ªõc khi JavaScript "ƒë√≥ng bƒÉng" tr√¨nh duy·ªát ƒë·ªÉ v·∫Ω b·∫£ng l·ªõn
        setTimeout(() => {
          reportData = JSON.parse(raw);
          renderReport(reportData);
        }, 100);
      };

      function renderReport(data) {
        document.getElementById("txtTenLop").innerText = data.layerName;
        document.getElementById("txtNgayLap").innerText =
          "Ng√†y l·∫≠p: " + data.date;
        document.getElementById("txtTongSo").innerText =
          data.features.length + " ƒë·ªëi t∆∞·ª£ng";

        const thead = document.getElementById("theadReport");
        const tbody = document.getElementById("tbodyReport");

        if (data.features.length === 0) return;

        // 1. T·∫°o ti√™u ƒë·ªÅ c·ªôt
        const firstProps = data.features[0].properties;
        const keys = Object.keys(firstProps).filter(
          (k) => !["bbox", "geom", "id"].includes(k),
        );

        let headRow = "<tr><th>STT</th>";
        keys.forEach((k) => {
          const tenTiengViet = TU_DIEN_COT[k] || k;
          headRow += `<th>${tenTiengViet}</th>`;
        });
        thead.innerHTML = headRow + "</tr>";

        // 2. ƒê·ªï d·ªØ li·ªáu (Gom th√†nh 1 chu·ªói HTML l·ªõn ƒë·ªÉ Render c·ª±c nhanh)
        let bodyHtml = "";
        data.features.forEach((f, index) => {
          let rowHtml = `<tr><td style="text-align:center;">${index + 1}</td>`;
          keys.forEach((k) => {
            const value =
              f.properties[k] !== null && f.properties[k] !== ""
                ? f.properties[k]
                : "-";
            rowHtml += `<td>${value}</td>`;
          });
          bodyHtml += rowHtml + "</tr>";
        });
        tbody.innerHTML = bodyHtml;

        // T·∫Øt m√†n h√¨nh ch·ªù
        document.getElementById("loading-overlay").style.display = "none";
      }

      // L·ªánh In
      document.getElementById("btnExportPDF").onclick = () => window.print();

      // L·ªánh xu·∫•t Excel b·∫±ng SheetJS
      document.getElementById("btnExportExcel").onclick = () => {
        if (!reportData) return;

        const excelRows = reportData.features.map((f, i) => {
          let row = { STT: i + 1 };
          for (let k in f.properties) {
            if (!["bbox", "geom", "id"].includes(k)) {
              const headerName = TU_DIEN_COT[k] || k;
              row[headerName] = f.properties[k];
            }
          }
          return row;
        });

        const worksheet = XLSX.utils.json_to_sheet(excelRows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "B√°o C√°o GIS");

        const fileName = `Bao_Cao_${reportData.layerName.replace(/\s+/g, "_")}.xlsx`;
        XLSX.writeFile(workbook, fileName);
      };
    </script>
  </body>
</html>
